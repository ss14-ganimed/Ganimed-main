using System.Linq;
using System.Numerics;
using Content.Client.Administration.UI.CustomControls;
using Content.Shared.Administration.Logs;
using Content.Shared.Database;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;
using static Robust.Client.UserInterface.Controls.BaseButton;
using static Robust.Client.UserInterface.Controls.LineEdit;

namespace Content.Client.Administration.UI.Logs;

[GenerateTypedNameReferences]
public sealed partial class AdminLogsControl : Control
{
    private readonly Comparer<AdminLogTypeButton> _adminLogTypeButtonComparer =
        Comparer<AdminLogTypeButton>.Create(
            (a, b) => string.Compare(a.Type.ToString(), b.Type.ToString(), StringComparison.Ordinal)
        );

    private readonly Comparer<AdminLogPlayerButton> _adminLogPlayerButtonComparer =
        Comparer<AdminLogPlayerButton>.Create(
            (a, b) => string.Compare(a.Text, b.Text, StringComparison.Ordinal)
        );

    private readonly Dictionary<LogType, string> _logTypePalette = new()
    {
        {LogType.Action, "#FFD54F"},
        {LogType.Chat, "#42A5F5"},
        {LogType.RCD, "#FF8A65"},
        {LogType.EmergencyShuttle, "#E53935"},
        {LogType.FieldGeneration, "#F44336"},

        {LogType.LateJoin, "#D1C4E9"},
        {LogType.RoundStartJoin, "#D1C4E9"},
        {LogType.GhostRoleTaken, "#D1C4E9"},
        {LogType.Identity, "#B39DDB"},
        {LogType.Respawn, "#9575CD"},

        {LogType.Teleport, "#7E57C2"},

        {LogType.Healed, "#8BC34A"},
        {LogType.Stamina, "#9CCC65"},
        {LogType.Ingestion, "#DCE775"},

        {LogType.ThrowHit, "#EF5350"},
        {LogType.BulletHit, "#EF5350"},
        {LogType.MeleeHit, "#EF5350"},
        {LogType.HitScanHit, "#EF5350"},
        {LogType.Electrocution, "#EF5350"},

        {LogType.Stripping, "#FF7043"},
        {LogType.ForceFeed, "#FF7043"},

        {LogType.Damaged, "#FF5722"},
        {LogType.Flammable, "#FF5722"},
        {LogType.Explosion, "#FF5722"},

        {LogType.AtmosFilterChanged, "#81D4FA"},
        {LogType.AtmosPowerChanged, "#81D4FA"},
        {LogType.AtmosPressureChanged, "#81D4FA"},
        {LogType.AtmosRatioChanged, "#81D4FA"},
        {LogType.AtmosVolumeChanged, "#81D4FA"},


    };

    private readonly Dictionary<LogImpact, string> _logImpactPalette = new()
    {
        {LogImpact.Low, "#E8F5E9"},
        {LogImpact.Medium, "#FFD54F"},
        {LogImpact.High, "#FF5722"},
        {LogImpact.Extreme, "#E53935"}
    };

    public AdminLogsControl()
    {
        RobustXamlLoader.Load(this);

        TypeSearch.OnTextChanged += TypeSearchChanged;
        PlayerSearch.OnTextChanged += PlayerSearchChanged;
        LogSearch.OnTextChanged += LogSearchChanged;

        SelectAllTypesButton.OnPressed += SelectAllTypes;
        SelectNoTypesButton.OnPressed += SelectNoTypes;

        IncludeNonPlayersButton.OnPressed += IncludeNonPlayers;
        SelectAllPlayersButton.OnPressed += SelectAllPlayers;
        SelectNoPlayersButton.OnPressed += SelectNoPlayers;

        RoundSpinBox.IsValid = i => i > 0 && i <= CurrentRound;
        RoundSpinBox.ValueChanged += RoundSpinBoxChanged;
        RoundSpinBox.InitDefaultButtons();

        ResetRoundButton.OnPressed += ResetRoundPressed;

        _adminLogsTextEditScrollBar.OnValueChanged += SyncAdminLogsScrollContainerScrollValue;
        AdminLogsScrollContainer.OnScrolled += SyncLogsTextEditScrollValue;

        RecievedLogs = new List<SharedAdminLog>();

        SwitchModeButton.OnPressed += SwitchViewMode;

        SetImpacts(Enum.GetValues<LogImpact>().OrderBy(impact => impact).ToArray());
        SetTypes(Enum.GetValues<LogType>());

        // find scrollbar in TextEdit's children
        // it must be at index 1, but may be changed in future
        for (var i = 0; i < AdminLogsTextEdit.ChildCount; i++)
        {
            if (AdminLogsTextEdit.GetChild(i) is VScrollBar scrollbar)
            {
                _adminLogsTextEditScrollBar = scrollbar;
                break;
            }
        }
    }

    private int CurrentRound { get; set; }

    public int SelectedRoundId => RoundSpinBox.Value;
    public string Search => LogSearch.Text;
    private int ShownLogs { get; set; }
    private int TotalLogs { get; set; }
    private int RoundLogs { get; set; }

    /// <summary>
    /// Storage of recieved logs
    /// </summary>
    private List<SharedAdminLog> RecievedLogs { get; set; }
    private bool IsInCopyMode { get; set; }
    private readonly VScrollBar _adminLogsTextEditScrollBar = new();

    public bool IncludeNonPlayerLogs { get; set; }

    public HashSet<LogType> SelectedTypes { get; } = new();

    public HashSet<Guid> SelectedPlayers { get; } = new();

    public HashSet<LogImpact> SelectedImpacts { get; } = new();

    public void SetCurrentRound(int round)
    {
        CurrentRound = round;
        ResetRoundButton.Text = Loc.GetString("admin-logs-reset-with-id", ("id", round));
        UpdateResetButton();
    }

    public void SetRoundSpinBox(int round)
    {
        RoundSpinBox.Value = round;
        UpdateResetButton();
    }

    private void RoundSpinBoxChanged(ValueChangedEventArgs args)
    {
        UpdateResetButton();
    }

    private void UpdateResetButton()
    {
        ResetRoundButton.Disabled = RoundSpinBox.Value == CurrentRound;
    }

    private void ResetRoundPressed(ButtonEventArgs args)
    {
        RoundSpinBox.Value = CurrentRound;
    }

    private void TypeSearchChanged(LineEditEventArgs args)
    {
        UpdateTypes();
    }

    private void PlayerSearchChanged(LineEditEventArgs args)
    {
        UpdatePlayers();
    }

    private void LogSearchChanged(LineEditEventArgs args)
    {
        UpdateLogs();
    }

    private void SelectAllTypes(ButtonEventArgs args)
    {
        SelectedTypes.Clear();

        foreach (var control in TypesContainer.Children)
        {
            if (control is not AdminLogTypeButton type)
            {
                continue;
            }

            type.Pressed = true;
            SelectedTypes.Add(type.Type);
        }

        UpdateLogs();
    }

    private void SelectNoTypes(ButtonEventArgs args)
    {
        SelectedTypes.Clear();

        foreach (var control in TypesContainer.Children)
        {
            if (control is not AdminLogTypeButton type)
            {
                continue;
            }

            type.Pressed = false;
            type.Visible = ShouldShowType(type);
        }

        UpdateLogs();
    }

    private void IncludeNonPlayers(ButtonEventArgs args)
    {
        IncludeNonPlayerLogs = args.Button.Pressed;

        UpdateLogs();
    }

    private void SelectAllPlayers(ButtonEventArgs args)
    {
        SelectedPlayers.Clear();

        foreach (var control in PlayersContainer.Children)
        {
            if (control is not AdminLogPlayerButton player)
            {
                continue;
            }

            player.Pressed = true;
            SelectedPlayers.Add(player.Id);
        }

        UpdateLogs();
    }

    private void SelectNoPlayers(ButtonEventArgs args)
    {
        SelectedPlayers.Clear();

        foreach (var control in PlayersContainer.Children)
        {
            if (control is not AdminLogPlayerButton player)
            {
                continue;
            }

            player.Pressed = false;
        }

        UpdateLogs();
    }

    public void SetTypesSelection(HashSet<LogType> selectedTypes, bool invert = false)
    {
        SelectedTypes.Clear();

        foreach (var control in TypesContainer.Children)
        {
            if (control is not AdminLogTypeButton type)
            {
                continue;
            }

            if (selectedTypes.Contains(type.Type) ^ invert)
            {
                type.Pressed = true;
                SelectedTypes.Add(type.Type);
            }
            else
            {
                type.Pressed = false;
                type.Visible = ShouldShowType(type);
            }
        }

        UpdateLogs();
    }

    public void UpdateTypes()
    {
        foreach (var control in TypesContainer.Children)
        {
            if (control is not AdminLogTypeButton type)
            {
                continue;
            }

            type.Visible = ShouldShowType(type);
        }
    }

    private void UpdatePlayers()
    {
        foreach (var control in PlayersContainer.Children)
        {
            if (control is not AdminLogPlayerButton player)
            {
                continue;
            }

            player.Visible = ShouldShowPlayer(player);
        }
    }

    private void SyncLogsTextEditScrollValue()
    {
        _adminLogsTextEditScrollBar.ValueTarget = AdminLogsScrollContainer.GetScrollValue().Y * 1.25f;
    }

    private void SyncAdminLogsScrollContainerScrollValue(Robust.Client.UserInterface.Controls.Range value)
    {
        AdminLogsScrollContainer.SetScrollValue(
            new Vector2(0, _adminLogsTextEditScrollBar.Value * 0.8f)
        );
    }

    private void SwitchViewMode(ButtonEventArgs args)
    {
        IsInCopyMode = !IsInCopyMode;

        if (IsInCopyMode)
        {
            SwitchModeButton.Text = Loc.GetString("admin-logs-view-mode");
            AdminLogsTextEdit.Visible = true;
            AdminLogsScrollContainer.Visible = false;
        }
        else
        {
            SwitchModeButton.Text = Loc.GetString("admin-logs-copy-mode");
            AdminLogsTextEdit.Visible = false;
            AdminLogsScrollContainer.Visible = true;
        }
    }

    private string GetLogTypeColor(LogType type)
    {
        if (_logTypePalette.TryGetValue(type, out var color))
        {
            return color;
        }
        else
        {
            return "#ffffff";
        }
    }

    private string GetImpactColor(LogImpact impact)
    {
        if (_logImpactPalette.TryGetValue(impact, out var color))
        {
            return color;
        }
        else
        {
            return "#ffffff";
        }
    }

    private void UpdateLogs()
    {
        ShownLogs = 0;
        var logsText = "";


        // build logs string
        for (var i = RecievedLogs.Count - 1; i >= 0; i--)
        {
            var log = RecievedLogs[i];
            if (ShouldShowLog(log))
            {
                ShownLogs++;
                logsText += string.Format(
                    "{0:HH:mm:ss} - [color={1}]{2}[/color] - [color={3}]{4}[/color]\n{5}\n\n",
                    log.Date,
                    GetImpactColor(log.Impact),
                    log.Impact,
                    GetLogTypeColor(log.Type),
                    log.Type,
                    log.Message
                );
            }
        }
        // set new text in TextEdit and clear rich markup for copy purposes
        AdminLogsTextEdit.TextRope = new Rope.Leaf(FormattedMessage.RemoveMarkup(logsText));
        // set new text in RichTextLabel for better viewing
        AdminLogsRichTextLabel.SetMessage(FormattedMessage.FromMarkup(logsText));

        UpdateCount(ShownLogs, RecievedLogs.Count);
        // Try to scroll logs to the end
        _adminLogsTextEditScrollBar.MoveToEnd();
        AdminLogsScrollContainer.SetScrollValue(
            new Vector2(0, float.NegativeInfinity)
        );
    }

    private bool ShouldShowType(AdminLogTypeButton button)
    {
        return button.Text != null &&
               button.Text.Contains(TypeSearch.Text, StringComparison.OrdinalIgnoreCase);
    }

    private bool ShouldShowPlayer(AdminLogPlayerButton button)
    {
        return button.Text != null &&
               button.Text.Contains(PlayerSearch.Text, StringComparison.OrdinalIgnoreCase);
    }

    private bool LogMatchesPlayerFilter(SharedAdminLog log)
    {
        if (log.Players.Length == 0)
            return SelectedPlayers.Count == 0 || IncludeNonPlayerLogs;

        return SelectedPlayers.Overlaps(log.Players);
    }

    private bool ShouldShowLog(SharedAdminLog log)
    {
        // Check log type
        if (!SelectedTypes.Contains(log.Type))
            return false;

        // Check players
        if (!LogMatchesPlayerFilter(log))
            return false;

        // Check impact
        if (!SelectedImpacts.Contains(log.Impact))
            return false;

        // Check search
        if (!log.Message.Contains(LogSearch.Text, StringComparison.OrdinalIgnoreCase))
            return false;

        return true;
    }

    private void TypeButtonPressed(ButtonEventArgs args)
    {
        var button = (AdminLogTypeButton) args.Button;
        if (button.Pressed)
        {
            SelectedTypes.Add(button.Type);
        }
        else
        {
            SelectedTypes.Remove(button.Type);
        }

        UpdateLogs();
    }

    private void PlayerButtonPressed(ButtonEventArgs args)
    {
        var button = (AdminLogPlayerButton) args.Button;
        if (button.Pressed)
        {
            SelectedPlayers.Add(button.Id);
        }
        else
        {
            SelectedPlayers.Remove(button.Id);
        }

        UpdateLogs();
    }

    private void ImpactButtonPressed(ButtonEventArgs args)
    {
        var button = (AdminLogImpactButton) args.Button;
        if (button.Pressed)
        {
            SelectedImpacts.Add(button.Impact);
        }
        else
        {
            SelectedImpacts.Remove(button.Impact);
        }

        UpdateLogs();
    }

    private void SetImpacts(LogImpact[] impacts)
    {
        LogImpactContainer.RemoveAllChildren();

        foreach (var impact in impacts)
        {
            var button = new AdminLogImpactButton(impact)
            {
                Text = impact.ToString()
            };

            SelectedImpacts.Add(impact);
            button.OnPressed += ImpactButtonPressed;

            LogImpactContainer.AddChild(button);
        }

        switch (impacts.Length)
        {
            case 0:
                return;
            case 1:
                LogImpactContainer.GetChild(0).StyleClasses.Add("OpenRight");
                return;
        }

        for (var i = 0; i < impacts.Length - 1; i++)
        {
            LogImpactContainer.GetChild(i).StyleClasses.Add("ButtonSquare");
        }

        LogImpactContainer.GetChild(LogImpactContainer.ChildCount - 1).StyleClasses.Add("OpenLeft");
    }

    private void SetTypes(LogType[] types)
    {
        var newTypes = types.ToHashSet();
        var buttons = new SortedSet<AdminLogTypeButton>(_adminLogTypeButtonComparer);

        foreach (var control in TypesContainer.Children.ToArray())
        {
            if (control is not AdminLogTypeButton type ||
                !newTypes.Remove(type.Type))
            {
                continue;
            }

            buttons.Add(type);
        }

        foreach (var type in newTypes)
        {
            var button = new AdminLogTypeButton(type)
            {
                Text = type.ToString(),
                Pressed = true
            };

            SelectedTypes.Add(type);
            button.OnPressed += TypeButtonPressed;

            buttons.Add(button);
        }

        TypesContainer.RemoveAllChildren();

        foreach (var type in buttons)
        {
            TypesContainer.AddChild(type);
        }

        UpdateLogs();
    }

    public void SetPlayers(Dictionary<Guid, string> players)
    {
        var buttons = new SortedSet<AdminLogPlayerButton>(_adminLogPlayerButtonComparer);

        foreach (var control in PlayersContainer.Children.ToArray())
        {
            if (control is not AdminLogPlayerButton player ||
                !players.Remove(player.Id))
            {
                continue;
            }

            buttons.Add(player);
        }

        foreach (var (id, name) in players)
        {
            var button = new AdminLogPlayerButton(id)
            {
                Text = name,
                Pressed = true
            };

            SelectedPlayers.Add(id);
            button.OnPressed += PlayerButtonPressed;

            buttons.Add(button);
        }

        PlayersContainer.RemoveAllChildren();

        foreach (var player in buttons)
        {
            PlayersContainer.AddChild(player);
        }

        UpdateLogs();
    }

    public void AddLogs(List<SharedAdminLog> logs)
    {
        RecievedLogs.AddRange(logs);
        UpdateLogs();
    }

    public void SetLogs(List<SharedAdminLog> logs)
    {
        RecievedLogs = logs;
        UpdateLogs();
    }

    public void UpdateCount(int? shown = null, int? total = null, int? round = null)
    {
        if (shown != null)
        {
            ShownLogs = shown.Value;
        }

        if (total != null)
        {
            TotalLogs = total.Value;
        }

        if (round != null)
        {
            RoundLogs = round.Value;
        }

        Count.Text = Loc.GetString(
            "admin-logs-count",
            ("showing", ShownLogs), ("total", TotalLogs), ("round", RoundLogs)
        );
    }

    protected override void Dispose(bool disposing)
    {
        base.Dispose(disposing);

        TypeSearch.OnTextChanged -= TypeSearchChanged;
        PlayerSearch.OnTextChanged -= PlayerSearchChanged;
        LogSearch.OnTextChanged -= LogSearchChanged;

        SelectAllTypesButton.OnPressed -= SelectAllTypes;
        SelectNoTypesButton.OnPressed -= SelectNoTypes;

        IncludeNonPlayersButton.OnPressed -= IncludeNonPlayers;
        SelectAllPlayersButton.OnPressed -= SelectAllPlayers;
        SelectNoPlayersButton.OnPressed -= SelectNoPlayers;

        RoundSpinBox.IsValid = null;
        RoundSpinBox.ValueChanged -= RoundSpinBoxChanged;

        ResetRoundButton.OnPressed -= ResetRoundPressed;

        SwitchModeButton.OnPressed -= SwitchViewMode;

        _adminLogsTextEditScrollBar.OnValueChanged -= SyncAdminLogsScrollContainerScrollValue;
        AdminLogsScrollContainer.OnScrolled -= SyncLogsTextEditScrollValue;
    }
}
